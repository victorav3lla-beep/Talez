<div class="universes-page-wrapper" style="background-image: url('/images/backgrounds/background.10.jpg');">
  <!-- Avatar Corner -->
  <%= render 'shared/avatar_corner' %>

  <!-- Floating Vector Background - Spawner System -->
  <div class="floating-background"
       data-controller="floating-spawner"
       id="universe-spawner"
       data-floating-spawner-images-value='<%= [
         { src: image_path("vectors/hot-air-balloon.png"), alt: "Balloon", width: 112 },
         { src: image_path("vectors/crown.png"), alt: "Crown", width: 88 },
         { src: image_path("vectors/moctezumas-headdress.png"), alt: "Headdress", width: 128 },
         { src: image_path("vectors/book.png"), alt: "Book", width: 80 },
         { src: image_path("vectors/razz-berry.png"), alt: "Berry", width: 64 },
         { src: image_path("vectors/rocket.png"), alt: "Rocket", width: 96 }
       ].to_json %>'>
    <!-- Pool o√π les floaters seront cr√©√©s dynamiquement -->
    <div data-floating-spawner-target="pool"></div>
  </div>

  <!-- TALEZ Logo - Top Left -->
  <div class="page-logo" data-controller="logo-switcher">
    <%= link_to dashboard_path, class: "logo-link" do %>
      <%= image_tag 'logo_talez_1.png', alt: 'TALEZ', class: 'logo-image', data: { logo_switcher_target: 'logo1' } %>
      <%= image_tag 'logo_talez_2.png', alt: 'TALEZ', class: 'logo-image', style: 'display: none;', data: { logo_switcher_target: 'logo2' } %>
    <% end %>
  </div>

  <div class="page-wrapper">
    <div class="container py-5" data-controller="selection">
      <!-- Simple magical title -->
      <div class="magical-title-section">
        <h1 class="magical-title">
          <span class="sparkle">üåç</span> Where Will Your Story Unfold? <span class="sparkle">üåç</span>
        </h1>
      </div>

      <%
        # Logic: 4 cards max, 1 row
        # Priority: custom universes first, then defaults, then "Create Your Own" if space
        custom_count = @custom_universes.size
        slots_for_defaults = [4 - custom_count, 3].min  # Max 3 defaults
        show_create_card = custom_count == 0  # Only show "Create Your Own" if no customs

        # Default universes data
        default_universes_data = [
          { id: @default_universes.first&.id || 1, name: "Enchanted Forest", image: "enchanted_forest.jpg", description: "A magical woodland filled with ancient trees and wonder!" },
          { id: @default_universes.second&.id || 2, name: "Galaxy Beyond", image: "galaxy_beyond.jpg", description: "A vast cosmos of stars, planets, and endless adventures!" },
          { id: @default_universes.third&.id || 3, name: "Future City", image: "future_city.jpeg", description: "A bustling metropolis of technology and innovation!" }
        ]
      %>

      <%= form_with url: select_universes_path, method: :post, data: { turbo: false } do |f| %>
        <%= f.hidden_field :id, value: "", data: { selection_target: "input" } %>

        <!-- Universes Showcase: 4 cards max, 1 row -->
        <!-- Order: Defaults (left) ‚Üí Custom/Create (right) -->
        <div class="characters-showcase">
          <div class="row g-4 justify-content-center">

            <%# Default Universes first (LEFT side) %>
            <% default_universes_data.first(slots_for_defaults).each do |uni_data| %>
              <div class="col-12 col-sm-6 col-lg-3" data-controller="tilt" data-action="mousemove->tilt#move mouseleave->tilt#leave">
                <div class="universe-card"
                     data-tilt-target="card"
                     data-selection-target="card"
                     data-id="<%= uni_data[:id] %>"
                     data-action="click->selection#select">
                  <div class="character-image-wrapper">
                    <%= image_tag uni_data[:image], alt: uni_data[:name] %>
                  </div>
                  <div class="character-content">
                    <h5 class="character-name"><%= uni_data[:name] %></h5>
                    <p class="character-description"><%= uni_data[:description] %></p>
                  </div>
                </div>
              </div>
            <% end %>

            <%# Custom Universes (RIGHT side, with action icons) %>
            <% @custom_universes.first(4 - slots_for_defaults).each do |universe| %>
              <%= render partial: "card", locals: { universe: universe, show_actions: true } %>
            <% end %>

            <%# Create Your Own Card (only if no custom universes) %>
            <% if show_create_card %>
              <div class="col-12 col-sm-6 col-lg-3" data-controller="tilt" data-action="mousemove->tilt#move mouseleave->tilt#leave">
                <%= link_to new_universe_path, class: "text-decoration-none" do %>
                  <div class="create-own-card" data-tilt-target="card">
                    <div class="create-content-wrapper">
                      <div class="create-icon">
                        <i class="bi bi-plus-circle"></i>
                      </div>
                      <h5 class="create-text">Create Your Own</h5>
                      <p class="create-subtext">Design your own world!</p>
                    </div>
                  </div>
                <% end %>
              </div>
            <% end %>

          </div>
        </div>

        <!-- Continue Button - Fixed at Bottom -->
        <div class="continue-button-wrapper">
          <%= f.submit "Continue", class: "btn btn-sunset btn-lg", disabled: true, data: { selection_target: "submitButton" } %>
        </div>
      <% end %>

      <!-- Back Button - At Bottom Left -->
      <%= link_to characters_path, class: "back-button" do %>
        <i class="fas fa-arrow-left me-2"></i>Back to Characters
      <% end %>
    </div>
  </div>
</div>
