<% is_owner = story.profile == current_profile %>
<% user_liked = story.likes.exists?(profile: current_profile) %>
<% user_like = story.likes.find_by(profile: current_profile) %>

<div class="library-story-card" data-controller="story-card">
  <!-- Image -->
  <div class="card-img-wrapper">
    <% first_image = story.cover.attached? ? story.cover : story.pages.order(:position).first&.image %>
    <% if first_image&.attached? %>
      <%= image_tag first_image, class: 'card-img', alt: story.title %>
    <% elsif story.images.attached? %>
      <%= image_tag story.images.first, class: 'card-img', alt: story.title %>
    <% else %>
      <%= image_tag 'default-story.png', class: 'card-img', alt: 'Default story image' %>
    <% end %>

    <!-- Status Badge Overlay (Only for owner) -->
    <% if is_owner %>
      <div class="card-status-badge">
        <span class="badge <%= story.public? ? 'badge-public' : 'badge-draft' %>">
          <%= story.public? ? 'ðŸ“– Public' : 'ðŸ“ Draft' %>
        </span>
      </div>
    <% end %>

    <!-- Author Badge (For community stories) -->
    <% unless is_owner %>
      <div class="card-author-badge">
        <i class="fas fa-user"></i>
        <%= story.profile.name %>
      </div>
    <% end %>
  </div>

  <!-- Card Body -->
  <div class="card-body-library">
    <!-- Title -->
    <h5 class="story-title-library">
      <%= link_to story.title || 'Untitled Story', story_path(story), class: 'story-link' %>
    </h5>

    <!-- Character & Universe Info -->
    <div class="story-meta-library">
      <% if story.characters.any? %>
        <div class="meta-item">
          <span class="meta-emoji">ðŸ§™</span>
          <span class="meta-text"><%= story.characters.first.name %></span>
        </div>
      <% end %>
      <% if story.universes.any? %>
        <div class="meta-item">
          <span class="meta-emoji">ðŸŒ²</span>
          <span class="meta-text"><%= story.universes.first.name %></span>
        </div>
      <% end %>
    </div>

    <!-- Timestamp -->
    <div class="story-timestamp">
      <i class="far fa-clock"></i>
      <%= time_ago_in_words(story.updated_at) %> ago
    </div>

    <!-- Action Buttons -->
    <div class="card-actions-library">
      <!-- Read Button -->
      <%= link_to story_path(story), class: 'btn-read' do %>
        <i class="fas fa-book-open"></i>
        Read
      <% end %>

      <div class="action-icons-library">
        <!-- Like Button -->
        <% if user_liked %>
          <%= button_to like_path(user_like), method: :delete,
              class: 'btn-action-library btn-like-action liked',
              title: 'Unlike',
              form: { data: { turbo: false } } do %>
            <i class="fas fa-heart"></i>
            <span class="likes-count"><%= story.likes_count %></span>
          <% end %>
        <% else %>
          <%= button_to story_likes_path(story), method: :post,
              class: 'btn-action-library btn-like-action',
              title: 'Like',
              form: { data: { turbo: false } } do %>
            <i class="far fa-heart"></i>
            <span class="likes-count"><%= story.likes_count %></span>
          <% end %>
        <% end %>

        <!-- Public/Private Toggle (Only for owner) -->
        <% if is_owner %>
          <%= button_to story_path(story), method: :patch,
              params: { story: { public: !story.public } },
              class: "btn-action-library btn-visibility-action #{story.public? ? 'public' : 'private'}",
              title: story.public? ? 'Make Private' : 'Make Public',
              form: { data: { turbo: false } } do %>
            <i class="fas <%= story.public? ? 'fa-eye' : 'fa-eye-slash' %>"></i>
          <% end %>
        <% end %>

        <!-- Delete Button (Only for owner) -->
        <% if is_owner %>
          <%= button_to story_path(story), method: :delete,
              data: { turbo_confirm: 'Are you sure you want to delete this story?' },
              class: 'btn-action-library btn-delete-action',
              title: 'Delete Story',
              form: { data: { turbo: false } } do %>
            <i class="fas fa-trash-alt"></i>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
</div>
