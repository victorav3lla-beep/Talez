<div class="story-show-page-wrapper">
  <div class="story-show-container">
    <!-- Sidebar -->
    <%= render 'shared/sidebar', active: 'stories' %>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Top Header -->
      <%= render 'shared/header', profile: current_profile %>

      <!-- Story Book Section -->
      <section class="story-book-section">
        <!-- Floating Sparkles -->
        <div class="sparkle sparkle-1"></div>
        <div class="sparkle sparkle-2"></div>
        <div class="sparkle sparkle-3"></div>
        <div class="sparkle sparkle-4"></div>
        <div class="sparkle sparkle-5"></div>

        <!-- Story Book Container -->
        <div class="story-book-container">
          <!-- Book Header -->
          <div class="book-header">
            <div class="book-header-content">
              <div class="book-title-badge">
                <i class="fas fa-book-open"></i>
                <span>Story Book</span>
              </div>
              <h1 class="book-title"><%= @story.title || "Untitled Story" %></h1>

              <!-- Story Meta -->
              <div class="story-meta-info">
                <% if @story.characters.any? %>
                  <span class="meta-tag meta-tag-character">
                    <i class="fas fa-user-astronaut"></i>
                    <%= @story.characters.first.name %>
                  </span>
                <% end %>
                <% if @story.universes.any? %>
                  <span class="meta-tag meta-tag-universe">
                    <i class="fas fa-globe-americas"></i>
                    <%= @story.universes.first.name %>
                  </span>
                <% end %>
                <span class="meta-tag meta-tag-pages">
                  <i class="fas fa-file-alt"></i>
                  <%= @story.pages.count %> / 3 pages
                </span>
              </div>

              <!-- Author Info -->
              <% if @story.profile %>
                <div class="story-author-info">
                  <span class="author-label">Created by</span>
                  <span class="author-name"><%= @story.profile.name %></span>
                </div>
              <% end %>
            </div>
          </div>

          <!-- Book Carousel -->
          <% if @story.cover.attached? || @story.pages.any? %>
            <div class="book-carousel-wrapper">
              <div id="storyBookCarousel" class="carousel slide carousel-fade" data-bs-ride="false">
                <!-- Page Indicators -->
                <div class="page-indicators">
                  <% if @story.cover.attached? %>
                    <button type="button"
                            data-bs-target="#storyBookCarousel"
                            data-bs-slide-to="0"
                            class="page-dot active"
                            aria-label="Cover">
                      <i class="fas fa-star"></i>
                    </button>
                  <% end %>
                  <% @story.pages.order(:position).each_with_index do |page, index| %>
                    <button type="button"
                            data-bs-target="#storyBookCarousel"
                            data-bs-slide-to="<%= @story.cover.attached? ? index + 1 : index %>"
                            class="page-dot <%= 'active' if index == 0 && !@story.cover.attached? %>"
                            aria-label="Page <%= page.position %>">
                      <%= page.position %>
                    </button>
                  <% end %>
                </div>

                <!-- Carousel Inner -->
                <div class="carousel-inner book-pages">
                  <!-- Cover Slide -->
                  <% if @story.cover.attached? %>
                    <div class="carousel-item active">
                      <div class="book-page cover-page">
                        <div class="page-image-wrapper">
                          <%= image_tag @story.cover, alt: @story.title, class: "page-img", loading: "lazy" %>
                          <div class="cover-overlay">
                            <h2 class="cover-title"><%= @story.title %></h2>
                          </div>
                        </div>
                      </div>
                    </div>
                  <% elsif @story.images.attached? %>
                    <div class="carousel-item active">
                      <div class="book-page cover-page">
                        <div class="page-image-wrapper">
                          <% @story.images.each do |image| %>
                            <%= image_tag image, alt: @story.title, class: "page-img", loading: "lazy" %>
                          <% end %>
                        </div>
                      </div>
                    </div>
                  <% end %>

                  <!-- Story Pages -->
                  <% @story.pages.order(:position).each_with_index do |page, index| %>
                    <div class="carousel-item <%= 'active' if index == 0 && !@story.cover.attached? && !@story.images.attached? %>">
                      <div class="book-page story-page">
                        <% if page.image.attached? %>
                          <div class="page-image-wrapper">
                            <%= image_tag page.image, alt: page.title, class: "page-img", loading: "lazy" %>
                          </div>
                          <div class="page-text-container">
                            <div class="page-number-badge">Page <%= page.position %></div>
                            <div class="page-story-text">
                              <% page.content.to_s.split(/(?<=[.!?])\s+/).each_slice(2) do |group| %>
                                <p><%= group.join(' ') %></p>
                              <% end %>
                            </div>
                          </div>
                        <% else %>
                          <div class="page-text-only">
                            <div class="page-number">Page <%= page.position %></div>
                            <div class="page-content">
                              <% page.content.to_s.split(/(?<=[.!?])\s+/).each_slice(2) do |group| %>
                                <p><%= group.join(' ') %></p>
                              <% end %>
                            </div>
                          </div>
                        <% end %>
                      </div>
                    </div>
                  <% end %>
                </div>

                <!-- Navigation Arrows -->
                <button class="book-nav book-nav-prev" type="button" data-bs-target="#storyBookCarousel" data-bs-slide="prev">
                  <i class="fas fa-chevron-left"></i>
                </button>
                <button class="book-nav book-nav-next" type="button" data-bs-target="#storyBookCarousel" data-bs-slide="next">
                  <i class="fas fa-chevron-right"></i>
                </button>
              </div>
            </div>
          <% end %>

          <!-- Continue Story Section -->
          <% if @story.pages.count < 3 %>
            <div class="continue-story-section">
              <div class="continue-header">
                <i class="fas fa-pen-fancy"></i>
                <h3>Continue Your Story</h3>
                <p>What happens next in your adventure?</p>
              </div>

              <%= simple_form_for :page, url: add_page_story_path(@story), method: :post, html: { class: 'continue-form' } do |f| %>
                <div class="form-wrapper">
                  <%= f.input :content,
                              label: false,
                              required: true,
                              as: :text,
                              input_html: {
                                rows: 3,
                                class: 'story-input',
                                placeholder: "Describe what happens next... (e.g., 'The hero discovers a hidden treasure!')"
                              } %>
                  <button type="submit" class="btn-add-page">
                    <i class="fas fa-magic"></i>
                    <span>Generate Next Page</span>
                  </button>
                </div>
              <% end %>

              <div class="story-progress">
                <div class="progress-bar">
                  <div class="progress-fill" style="width: <%= (@story.pages.count / 3.0 * 100).to_i %>%"></div>
                </div>
                <span class="progress-text"><%= @story.pages.count %> of 3 pages complete</span>
              </div>
            </div>
          <% else %>
            <div class="story-complete-section">
              <div class="complete-badge">
                <i class="fas fa-check-circle"></i>
                <span>Story Complete!</span>
              </div>
              <p>Your adventure is complete. Share it with the world!</p>

              <% if @story.profile == current_profile %>
                <div class="complete-actions">
                  <%= render partial: "stories/visibility_toggle", locals: { story: @story } %>
                </div>
              <% end %>
            </div>
          <% end %>

          <!-- Action Buttons -->
          <div class="book-actions">
            <%= link_to stories_path, class: "book-btn book-btn-secondary" do %>
              <i class="fas fa-book"></i>
              <span>Library</span>
            <% end %>

            <% if @story.pages.count >= 3 %>
              <%= link_to print_story_path(@story), class: "book-btn book-btn-accent", target: "_blank" do %>
                <i class="fas fa-print"></i>
                <span>Print Story</span>
              <% end %>
            <% end %>

            <% if @story.profile == current_profile %>
              <%= link_to story_path(@story), method: :delete, data: { confirm: 'Are you sure you want to delete this story?' }, class: "book-btn book-btn-danger" do %>
                <i class="fas fa-trash-alt"></i>
                <span>Delete</span>
              <% end %>
            <% end %>

            <%= link_to new_story_path, class: "book-btn book-btn-primary" do %>
              <i class="fas fa-wand-magic-sparkles"></i>
              <span>New Story</span>
            <% end %>
          </div>

          <!-- Like Section -->
          <div class="book-like-section">
            <% if user_signed_in? && current_profile %>
              <% user_liked = @story.likes.exists?(profile: current_profile) %>
              <% user_like = @story.likes.find_by(profile: current_profile) %>
              <% if user_liked %>
                <%= button_to like_path(user_like), method: :delete,
                    class: 'book-like-btn liked',
                    form: { data: { turbo: false } } do %>
                  <i class="fas fa-heart"></i>
                  <span class="like-count"><%= @story.likes_count %></span>
                  <span class="like-text">Liked</span>
                <% end %>
              <% else %>
                <%= button_to story_likes_path(@story), method: :post,
                    class: 'book-like-btn',
                    form: { data: { turbo: false } } do %>
                  <i class="far fa-heart"></i>
                  <span class="like-count"><%= @story.likes_count %></span>
                  <span class="like-text">Like this story</span>
                <% end %>
              <% end %>
            <% else %>
              <div class="book-like-info">
                <i class="fas fa-heart"></i>
                <span><%= @story.likes_count %> likes</span>
              </div>
            <% end %>
          </div>
        </div>
      </section>
    </div>
  </div>
</div>
